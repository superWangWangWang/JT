<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Layui</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../layui/css/layui.css" media="all">
    <script src="../index/assets/js/jquery-1.10.2.js"></script>
    <script src="../layui/layui.js" charset="utf-8"></script>

</head>
<body>
<form class="layui-form layui-form-pane" action="" id="table_form">

    <div style="padding: 20px; background-color: #F2F2F2;">
        <div class="layui-row layui-col-space15">
            <div class="layui-col-md12">
                <div class="layui-card">
                    <div class="layui-card-body">
                        <fieldset class="layui-elem-field layui-field-title">
                            <legend>筛选</legend>
                        </fieldset>
                        <blockquote class="layui-elem-quote">
                            <div class="layui-inline">
                                <label class="layui-form-label">文件类型</label>
                                <div class="layui-input-inline">
                                    <select id="file_type" lay-search="" lay-filter="file_type">
                                        <option value="plan" selected="">平面图</option>
                                        <option value="msds">msds</option>
                                        <option value="product">生产设备名录</option>
                                        <option value="evidence">佐证</option>
                                    </select>

                                </div>
                            </div>
                            <div class="layui-inline" id="companys_div">
                                <label class="layui-form-label">公司</label>
                                <div class="layui-input-inline" id="companys"></div>
                            </div>
                            <div class="layui-inline" id="materials_div">
                                <label class="layui-form-label">物料</label>
                                <div class="layui-input-inline" id="materials"></div>
                            </div>

                            <div class="layui-inline" id="date_div">
                                <label class="layui-form-label">日期</label>
                                <div class="layui-input-block">
                                    <input type="text" name="date" id="date" autocomplete="off" class="layui-input"
                                           data-type="reload">
                                </div>
                            </div>


                        </blockquote>
                        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                        </fieldset>
                        <table class="layui-hide" id="file" lay-filter="file"></table>


                    </div>
                </div>
            </div>
        </div>

    </div>
</form>
<script type="text/html" id="bar">
    <a class="layui-btn layui-btn-xs" lay-event="download">下载</a>
</script>
<script>

    layui.use(['table', 'form', 'laydate'], function () {
        var table = layui.table, $ = layui.jquery, form = layui.form, laydate = layui.laydate;
        var material_select;
        var company_select;


        //获取物料赋值于选择框
        function add_material_select() {
            $.get("../admin/findMaterials", function (data) {
                material_select = '<select id="material_select" lay-search="" lay-filter="material_select" ><option value="">选择或手动输入</option>';
                for (var i = 0; i < data.data.length; i++) {
                    material_select += '<option value="' + data.data[i].物料名称 + '">' + data.data[i].物料名称 + '</option>'
                }
                material_select += "</select>";
                $('#materials').html(material_select)
                form.render();//重新渲染
            })
        }
        //获取公司信息赋值于选择框
        function add_company_select() {
            $.get("../admin/companyList", function (data) {

                company_select = '<select id="company_select" lay-search="" lay-filter="company_select" ><option value="">选择或手动输入</option>';

                for (var i = 0; i < data.data.length; i++) {
                    if (data.data[i]['user'] != 'admin') {//排除自己
                        company_select += '<option value="' + data.data[i]['企业简称'] + '">' + data.data[i]['企业简称'] + '</option>'
                    }
                }
                company_select += "</select>";
                $('#companys').html(company_select)
                form.render();//重新渲染
            }, "json")
        }

        add_company_select();
        add_material_select();


        ////搜索功能部分


        var date_search; //日期选择标识
        var company_search; //公司选择标识
        var material_search; //物料选择标识
        /**
         * 当日期选择框选择后
         * */
        lay('#date').on('click', function () {
            ///alert("aaa")
            laydate.render({
                elem: '#date'
                , type: 'month'
                , show: true
                , closeStop: '#date'
                , done: function (value, date) {//value, date, endDate点击日期、清空、现在、确定均会触发。回调返回三个参数，分别代表：生成的值、日期时间对象、结束的日期时间对象
                    date_search = value;
                    //执行重载
                    tableReload();

                }
            });


        });


        /**
         * 文件类型选择框 触发
         **/
        $("#date_div").hide();
        $("#materials_div").hide();
        $("#companys_div").hide();
        var select_type = 'plan'; //选择类型 初始化是平面图plan
        form.on('select(file_type)', function (data) {
            select_type = data.value;
            if (data.value == "plan") {//平面图

                $("#date_div").hide();
                $("#materials_div").hide();
                $("#companys_div").hide();
                plan_info();
            } else if (data.value == "product") {//产品
                $("#date_div").hide();
                $("#materials_div").hide();
                $("#companys_div").hide();
                product_info();
            } else if (data.value == "msds") {//msds
                msds_info();
                $("#date_div").hide();
                $("#materials_div").show();
                $("#companys_div").show();
            } else if (data.value == "evidence") {//佐证
                evidence_info();
                $("#date_div").show();
                $("#materials_div").hide();
                $("#companys_div").show();
            }


        });


        /**
         * 当公司选择框选择后
         * */
        form.on('select(company_select)', function (data) {
            company_search = data.value;
            tableReload();
        });

        /**
         * 当物料选择框选择后
         * */
        form.on('select(material_select)', function (data) {
            material_search = data.value;
            tableReload();
        });

        //表单传送搜索条件
        function tableReload() {
            console.log($("#company_select").val() + "," + $("#material_select").val() + "," + $("#date").val())
            table.reload('file', {
                page: {
                    curr: 1 //重新从第 1 页开始
                }
                , where: {
                    date: date_search,
                    company: company_search,
                    material: material_search
                }
            }, 'data');
        }

        /**
         * 平面图 表格数据
         * **/
        function plan_info() {

            table.render({
                elem: '#file'
                , url: '../admin/findFileByType?type=plan'
                , cols: [[
                    {field: 'id', title: 'ID', sort: true}
                    , {field: '企业全称', title: '企业全称'}
                    , {field: 'planName', title: '平面图名称'}
                    , {fixed: 'right', title: '操作', toolbar: '#bar', width: 150}
                ]]
                , page: true
            });
        }

        plan_info();//默认初始化是平面图


        /**
         *  产品设备明录 表格数据
         * **/
        function product_info() {

            table.render({
                elem: '#file'
                , url: '../admin/findFileByType?type=product'
                , cols: [[
                    {field: 'id', title: 'ID', sort: true}
                    , {field: '企业全称', title: '企业全称'}
                    , {field: 'productName', title: '平面图名称'}
                    , {fixed: 'right', title: '操作', toolbar: '#bar', width: 150}
                ]]
                , page: true
            });
        }

        /**
         * 平面图 表格数据
         * **/
        function msds_info() {

            table.render({
                elem: '#file'
                , url: '../admin/findFileByType?type=msds'
                , cols: [[
                    {field: 'id', title: 'ID', sort: true}
                    , {
                        field: 'updateDatetime',
                        title: '上传时间',
                        sort: true,
                        templet: '<div>{{ layui.util.toDateString(d.pressTime, "yyyy-MM-dd HH:mm:ss") }}</div>'
                    }
                    , {field: 'company', title: '所属公司'}
                    , {field: 'material', title: '所属物料'}
                    , {field: 'msdsFilename', title: 'msds文件名'}
                    , {fixed: 'right', title: '操作', toolbar: '#bar', width: 150}
                ]]
                , page: true
            });
        }

        /**
         * 佐证 表格数据
         * **/
        function evidence_info() {

            table.render({
                elem: '#file'
                , url: '../admin/findFileByType?type=evidence'
                , cols: [[
                    {field: 'id', title: 'ID', sort: true}
                    , {field: 'datetime', title: '上传时间'}
                    , {field: 'company', title: '所属公司'}
                    //, {field: 'filename', title: 'msds文件名'}
                    , {fixed: 'right', title: '操作', toolbar: '#bar', width: 150}
                ]]
                , page: true
            });
        }

        /**
         * 下载按钮
         * **/
        table.on('tool(file)', function (obj) {
                var data = obj.data;
                //console.log(obj)
                if (obj.event === 'download') {
                    //alert(data.id)
                    location.href = '../admin/downloadFile?folder='+ select_type +'&id=' + data.id;

                }
            }
        );


    });
</script>

</body>
</html>