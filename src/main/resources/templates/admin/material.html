<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Layui</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../layui/css/layui.css" media="all">
    <script src="../index/assets/js/jquery-1.10.2.js"></script>
    <script src="../layui/layui.js" charset="utf-8"></script>

</head>
<body>
<form class="layui-form layui-form-pane" action="" id="table_form">

    <div style="padding: 20px; background-color: #F2F2F2;">
        <div class="layui-row layui-col-space15">
            <div class="layui-col-md12">
                <div class="layui-card">
                    <div class="layui-card-body">
                        <fieldset class="layui-elem-field layui-field-title">
                            <legend>筛选</legend>
                        </fieldset>
                        <blockquote class="layui-elem-quote">
                            <div class="layui-inline">
                                <label class="layui-form-label">公司</label>
                                <div class="layui-input-inline" id="companys"></div>
                            </div>

                            <div class="layui-inline">
                                <label class="layui-form-label">物料</label>
                                <div class="layui-input-inline" id="materials"></div>
                            </div>

                            <div class="layui-inline">
                                <label class="layui-form-label">日期</label>
                                <div class="layui-input-block">
                                    <input type="text" name="date" id="date" autocomplete="off" class="layui-input" data-type="reload">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <div class="layui-input-block" style="margin-left: 30px;">
                                    <button type="button" class="layui-btn" id="export_material">
                                        <i class="layui-icon">&#xe67d;</i> 导出
                                    </button>
                                </div>
                            </div>


                        </blockquote>
                        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                        </fieldset>

                        <table class="layui-table"
                               lay-data="{url:'searchDeclareRecords', page:true, totalRow: true, title: '用户数据表', id:'material', limit: 15, limits: [15, 20]}"
                               lay-filter="material">
                            <thead>
                            <tr>
                                <th lay-data="{field:'id', width:80, sort: true, unresize: true, sort: true, totalRowText: '合计'}">
                                    id
                                </th>
                                <th lay-data="{field:'company', width:120,}">所属公司</th>
                                <th lay-data="{field:'datetime', minWidth: 150}">录入时间</th>
                                <th lay-data="{field:'material', minWidth: 150}">物料名称</th>
                                <th lay-data="{field:'unit', minWidth: 150}">物料单位</th>
                                <th lay-data="{field:'element', minWidth: 100}">物料成分</th>
                                <th lay-data="{field:'content',minWidth: 150}">成分含量</th>
                                <th lay-data="{field:'dosage', minWidth: 150, sort: true, totalRow: true}">
                                    当月用量
                                </th>
                            </tr>
                            </thead>

                        </table>

                    </div>
                </div>
            </div>
        </div>

    </div>
</form>

<script>

    layui.use([ 'table', 'form', 'laydate' ], function () {
        var table = layui.table, $ = layui.jquery, form = layui.form, laydate = layui.laydate;
        var material_select;
        var company_select;
        //获取物料赋值于选择框
        function add_material_select() {
            $.get("../admin/findMaterials", function (data) {
                material_select = '<select id="material_select" lay-search="" lay-filter="material_select" ><option value="">选择或手动输入</option>';
                for (var i = 0; i < data.data.length; i++) {
                    material_select += '<option value="' + data.data[i].物料名称 + '">' + data.data[i].物料名称 + '</option>'
                }
                material_select += "</select>";
                $('#materials').html(material_select)
                form.render();//重新渲染
            })
        }
        function add_company_select() {
            $.get("../admin/companyList", function (data) {

                company_select = '<select id="company_select" lay-search="" lay-filter="company_select" ><option value="">选择或手动输入</option>';

                for (var i = 0; i < data.data.length; i++) {
                    if(data.data[i]['user'] != 'admin'){//排除自己
                        company_select += '<option value="' + data.data[i]['企业简称'] + '">' + data.data[i]['企业简称'] + '</option>'
                    }
                }
                company_select += "</select>";
                $('#companys').html(company_select)
                form.render();//重新渲染
            },"json")
        }
        add_company_select();
        add_material_select();



        ////搜索功能部分


        var date_search; //日期选择标识
        var company_search; //公司选择标识
        var material_search; //物料选择标识
        //单击我触发--时间
        lay('#date').on('click', function(){
            ///alert("aaa")
            laydate.render({
                elem: '#date'
                ,type: 'month'
                ,show: true
                ,closeStop: '#date'
                ,done: function(value, date){//value, date, endDate点击日期、清空、现在、确定均会触发。回调返回三个参数，分别代表：生成的值、日期时间对象、结束的日期时间对象
                    date_search = value;
                    //执行重载
                    tableReload();

                }
            });


        });
        var date_search; //日期选择标识
        var company_search; //公司选择标识
        var material_search; //物料选择标识
        //表单导出
        layui.$('#export_material').on('click', function () {
            $.post("../admin/exportToMaterial", {'date': date_search, 'company': company_search, 'material': material_search},  function (data) {
                /****格式
                table.exportFile(['名字','性别','年龄'], [
                    ['张三','男','20'],
                    ['李四','女','18'],
                    ['王五','女','19']
                ], 'xls'); //默认导出 csv，也可以为：xls
                 */
                console.log(JSON.stringify(data.data) )
                table.exportFile(data.data.title, data.data.result, 'xls');
            },"json")


        });
        form.on('select(material_select)', function(data){
            material_search = data.value;
            tableReload();
        });

        form.on('select(company_select)', function(data){
            company_search = data.value;
            tableReload();
        });
        //表单传送搜索条件
        function tableReload(){
            console.log($("#company_select").val() + "," + $("#material_select").val() + "," + $("#date").val())
            table.reload('material', {
                page: {
                    curr: 1 //重新从第 1 页开始
                }
                ,where: {
                    date: date_search,
                    company: company_search,
                    material: material_search
                }
            }, 'data');
        }

    });


</script>

</body>
</html>